<!-- Krok 1: WybÃ³r Obszaru CiaÅ‚a -->
<div *ngIf="currentStep === 1" class="step step-1">
  <h2>ğŸ”¹ Krok 1: WybÃ³r Obszaru CiaÅ‚a</h2>
  <p>Witaj! Jestem botem medycznym. WskaÅ¼, ktÃ³ra czÄ™Å›Ä‡ ciaÅ‚a CiÄ™ niepokoi, klikajÄ…c odpowiedni obszar na schemacie.</p>
  <div class="image-container">
    <img src="/sylwetka_optimized.png" alt="Sylwetka czÅ‚owieka" />
    <svg class="overlay-svg">
      <polygon 
        points="165,106,169,105,182,108,196,109,215,107,221,105,225,105,225,131,228,149,230,158,227,168,225,180,223,192,211,197,190,198,178,196,167,191,165,173,161,162,164,137"
        [attr.class]="selectedArea === 'chest' ? 'clickable-area selected' : 'clickable-area'"
        (click)="onSelect('chest')">
      </polygon>
    </svg>
  </div>
</div>

<!-- Krok 2: Potwierdzenie Wyboru -->
<div *ngIf="currentStep === 2" class="step step-2">
  <h2>ğŸ”¹ Krok 2: Potwierdzenie Wyboru</h2>
  <p>WybraÅ‚eÅ›: <strong>{{ selectedAreaName }}</strong>. PomogÄ™ Ci oceniÄ‡ Twoje objawy i doradzÄ™, co dalej.</p>
  <p>Czy to wÅ‚aÅ›ciwy obszar, ktÃ³rego dotyczÄ… Twoje dolegliwoÅ›ci?</p>
  <div class="buttons">
    <button (click)="goToStep(3)">âœ… Tak</button>
    <button (click)="goToStep(1)">âŒ Nie</button>
  </div>
</div>

<!-- Krok 3: Zbieranie ObjawÃ³w -->
<div *ngIf="currentStep === 3" class="step step-3">
  <h2>ğŸ”¹ Krok 3: Zbieranie ObjawÃ³w</h2>
  <p>ğŸ“‹ Lista objawÃ³w dla: <strong>{{ selectedAreaName }}</strong></p>
  <div class="symptoms-list">
    <h3>1. BÃ³l w klatce piersiowej:</h3>
    <label>
      Lokalizacja:
      <select name="chestPainLocation" [(ngModel)]="symptoms.chestPain.location">
        <option value="centralny">Centralny</option>
        <option value="lewy">Lewy</option>
        <option value="prawy">Prawy</option>
        <option value="promieniujÄ…cy">PromieniujÄ…cy</option>
        <option value="nie wiem">Nie wiem</option>
      </select>
    </label>
    <label>
      Charakter:
      <select name="chestPainCharacter" [(ngModel)]="symptoms.chestPain.character">
        <option value="kÅ‚ujÄ…cy">KÅ‚ujÄ…cy</option>
        <option value="Å›ciskajÄ…cy">ÅšciskajÄ…cy</option>
        <option value="piekÄ…cy">PiekÄ…cy</option>
        <option value="nie wiem">Nie wiem</option>
      </select>
    </label>
    <label>
      Nasilenie (1â€“10):
      <input name="chestPainIntensity" type="number" [(ngModel)]="symptoms.chestPain.intensity" min="1" max="10">
    </label>

    <h3>2. DusznoÅ›Ä‡:</h3>
    <label>
      <input name="shortnessRest" type="checkbox" [(ngModel)]="symptoms.shortnessOfBreath.rest" 
             [disabled]="symptoms.shortnessOfBreath.none" (change)="onShortnessNoneChange()">
      W spoczynku
    </label>
    <label>
      <input name="shortnessExercise" type="checkbox" [(ngModel)]="symptoms.shortnessOfBreath.exercise" 
             [disabled]="symptoms.shortnessOfBreath.none" (change)="onShortnessNoneChange()">
      Przy wysiÅ‚ku
    </label>
    <label>
      <input name="shortnessNone" type="checkbox" [(ngModel)]="symptoms.shortnessOfBreath.none" 
             (change)="onShortnessNoneChange()">
      Brak
    </label>
    <label>
      <input name="shortnessDunno" type="checkbox" [(ngModel)]="symptoms.shortnessOfBreath.dunno" 
             (change)="onShortnessNoneChange()">
      Nie wiem
    </label>

    <h3>3. Kaszel:</h3>
    <label>
      <input name="coughDry" type="radio" [(ngModel)]="symptoms.cough.type" value="dry" (change)="onCoughTypeChange()">
      Suchy
    </label>
    <label>
      <input name="coughWet" type="radio" [(ngModel)]="symptoms.cough.type" value="wet" (change)="onCoughTypeChange()">
      Mokry
    </label>
    <label>
      <input name="coughNone" type="radio" [(ngModel)]="symptoms.cough.type" value="none" (change)="onCoughTypeChange()">
      Brak
    </label>
    <label>
      <input name="coughBlood" type="checkbox" [(ngModel)]="symptoms.cough.blood" 
             [disabled]="symptoms.cough.type === 'none' || symptoms.cough.type === 'dunno'">
      Z krwiÄ…
    </label>
    <label>
      <input name="coughDunno" type="radio" [(ngModel)]="symptoms.cough.type" value="dunno" (change)="onCoughTypeChange()">
      Nie wiem
    </label>
    <p *ngIf="symptoms.cough.blood && symptoms.cough.type === 'dry'" class="warning">
      âš ï¸ Uwaga: Suchy kaszel z krwiÄ… moÅ¼e wskazywaÄ‡ na powaÅ¼niejsze problemy zdrowotne.
    </p>

    <h3>4. Inne Objawy:</h3>
    <label>
      <input name="otherBreathingPain" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.breathingPain" 
             [disabled]="symptoms.otherSymptoms.none">
      BÃ³l przy oddychaniu
    </label>
    <label>
      <input name="otherPalpitations" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.palpitations" 
             [disabled]="symptoms.otherSymptoms.none">
      KoÅ‚atanie serca
    </label>
    <label>
      <input name="otherColdSweats" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.coldSweats" 
             [disabled]="symptoms.otherSymptoms.none">
      Zimne poty
    </label>
    <label>
      <input name="otherDizziness" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.dizziness" 
             [disabled]="symptoms.otherSymptoms.none">
      Zawroty gÅ‚owy
    </label>
    <label>
      <input name="otherFever" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.fever" 
             [disabled]="symptoms.otherSymptoms.none">
      GorÄ…czka
    </label>
    <label>
      <input name="otherNausea" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.nausea" 
             [disabled]="symptoms.otherSymptoms.none">
      NudnoÅ›ci
    </label>
    <label>
      <input name="otherNone" type="checkbox" [(ngModel)]="symptoms.otherSymptoms.none" 
             (change)="onOtherSymptomsNoneChange()">
      Brak
    </label>

    <h3>5. ğŸ©¸ NawrÃ³t Kapilarny:</h3>
    <p>ZnajdÅº dobrze oÅ›wietlone miejsce i wykonaj nastÄ™pujÄ…ce kroki:</p>
    <ol>
      <li>Uciskaj opuszek przez 5 sekund, aÅ¼ zbieleje.</li>
      <li>PuÅ›Ä‡ i obserwuj, jak szybko wraca jego naturalny kolor.</li>
      <li>Zmierz czas (w sekundach).</li>
    </ol>
    <label>
      Wynik testu (sekundy):
      <input name="capillaryRefillTime" type="number" [(ngModel)]="symptoms.capillaryRefillTime">
    </label>
    <p>
      Wynik:
      <span *ngIf="symptoms.capillaryRefillTime !== null">
        {{ symptoms.capillaryRefillTime <= 2 ? 'âœ… PrawidÅ‚owy' : 'âŒ NieprawidÅ‚owy' }}
      </span>
    </p>
    <button (click)="goToStep(4)">Dalej</button>
  </div>
</div>

<!-- Krok 4: Historia Medyczna i Dodatkowe Pytania + SI -->
<div *ngIf="currentStep === 4" class="step step-4">
  <form class="medical-form">
    <h2>ğŸ”¹ Krok 4: Historia Medyczna i Dodatkowe Pytania</h2>
    
    <h3>1. Choroby przewlekÅ‚e:</h3>
    <label>
      <input name="hypertension" type="checkbox" [(ngModel)]="medicalHistory.hypertension">
      NadciÅ›nienie
    </label>
    <label>
      <input name="diabetes" type="checkbox" [(ngModel)]="medicalHistory.diabetes">
      Cukrzyca
    </label>
    <label>
      <input name="asthma" type="checkbox" [(ngModel)]="medicalHistory.asthma">
      Astma
    </label>
    <label>
      <input name="heartDisease" type="checkbox" [(ngModel)]="medicalHistory.heartDisease">
      Choroby serca
    </label>
    <label>
      <input name="thyroidIssues" type="checkbox" [(ngModel)]="medicalHistory.thyroidIssues">
      Problemy z tarczycÄ…
    </label>
    
    <h3>2. Przyjmowane leki:</h3>
    <label>
      <input name="takesMedication" type="checkbox" [(ngModel)]="medicalHistory.takesMedication">
      Przyjmujesz leki regularnie?
    </label>
    <label *ngIf="medicalHistory.takesMedication">
      SzczegÃ³Å‚y lekÃ³w:
      <input name="medicationDetails" type="text" [(ngModel)]="medicalHistory.medicationDetails">
    </label>
    
    <h3>3. Parametry zdrowotne:</h3>
    <label>
      CiÅ›nienie krwi:
      <input name="bloodPressure" type="text" [(ngModel)]="medicalHistory.bloodPressure">
    </label>
    <label>
      Saturacja:
      <input name="saturation" type="number" [(ngModel)]="medicalHistory.saturation">
    </label>
    <label>
      TÄ™tno:
      <input name="heartRate" type="number" [(ngModel)]="medicalHistory.heartRate">
    </label>
    <label>
      Poziom glukozy:
      <input name="glucoseLevel" type="number" [(ngModel)]="medicalHistory.glucoseLevel">
    </label>
    
    <h3>4. Czas trwania objawÃ³w:</h3>
    <label>
      <select name="symptomDuration" [(ngModel)]="medicalHistory.symptomDuration">
        <option value="" disabled selected>Wybierz czas trwania objawÃ³w</option>
        <option value="short">Mniej niÅ¼ 1 godzina</option>
        <option value="medium">1â€“24 godziny</option>
        <option value="long">Ponad 24 godziny</option>
      </select>
    </label>
    
    <!-- Pytanie o SI -->
    <h3>Dodatkowe pytanie:</h3>
    <label>
      <input name="aiPrediction" type="checkbox" [(ngModel)]="aiPrediction">
      Czy chcesz, aby Sztuczna Inteligencja przewidziaÅ‚a chorobÄ™?
    </label>
    <div *ngIf="aiPrediction">
      <label>
        Opis objawÃ³w (wypisz dokÅ‚adne objawy, kaÅ¼dy oddzielajÄ…c przecinkiem):<br>
        <textarea name="opisObjawow" [(ngModel)]="opisObjawow" rows="4" cols="50"></textarea>
      </label>
    </div>
    
    <button type="button" (click)="submitMedicalHistory()">Dalej</button>
  </form>
</div>

<!-- Krok 5: Podsumowanie i (lokalna) predykcja -->
<div *ngIf="currentStep === 5" class="step step-5">
  <h2>ğŸ”¹ Krok 5: Podsumowanie i predykcja</h2>
  <p>Twoje dane <strong>nie zostanÄ…</strong> zapisane w bazie. ZostanÄ… uÅ¼yte tylko do lokalnej analizy.</p>
  
  <!-- Przycisk do obliczania wyniku -->
  <button (click)="computeResultLocally()">Oblicz wynik</button>

  <!-- Loader - animacja "myÅ›lenia" -->
  <div *ngIf="isComputing" class="loader-overlay">
    <div class="loader"></div>
    <p>ProszÄ™ czekaÄ‡, trwa analiza...</p>
  </div>

  <!-- Sekcja z wynikami (pokazywana gdy isComputing = false) -->
  <div *ngIf="(!isComputing) && (predictedTriage || predictedDisease)" class="analysis-results">
    <h3 class="analysis-header">Wyniki lokalnej analizy:</h3>
    
    <!-- Karta z wynikami -->
    <div class="result-card">
      <div class="result-item">
        <strong>TRIAGE:</strong>
        <span
        [ngClass]="{
          'triage-blue':   predictedTriage === 'Niebieski',
          'triage-green':  predictedTriage === 'Zielony',
          'triage-yellow': predictedTriage === 'Å»Ã³Å‚ty',
          'triage-orange': predictedTriage === 'PomaraÅ„czowy',
          'triage-red':    predictedTriage === 'Czerwony'
        }"
      >
        {{ predictedTriage }}
      </span>
      </div>

      <div *ngIf="predictedDisease" class="result-item" style="flex-direction: column;">
        <strong>Choroba:</strong>
        <span>{{ predictedDisease }}</span>
      </div>
      
      <div *ngIf="triageGuide" class="result-item" style="flex-direction: column;">
        <strong>DziaÅ‚anie:</strong>
        <span>{{ triageGuide }}</span>
      </div>
              
    </div>

    <!-- Dodatkowa logika dla "PomaraÅ„czowego" -->
    <div *ngIf="predictedTriage === 'PomaraÅ„czowy'" class="result-extra">
      <p><strong>Czy jesteÅ› w stanie dotrzeÄ‡ tam samodzielnie?</strong></p>
      <button (click)="setCanReachSor(true)">Tak</button>
      <button (click)="setCanReachSor(false)">Nie</button>

      <div *ngIf="canReachSor === true">
        <p>Mapa SOR:</p>
        <div class="map-sor-container">
          <iframe
            width="600"
            height="400"
            src="https://pacjent.gov.pl/szpitalny-oddzial-ratunkowy-sor"
            style="border:0;"
            allowfullscreen
            loading="lazy">
          </iframe>
        </div>
      </div>
      <div *ngIf="canReachSor === false" style="margin-top:0.5rem;">
        <p>ZadzwoÅ„ pod numer 112 i poproÅ› o karetkÄ™!!!</p>
      </div>
    </div>
  </div>

  <button (click)="resetForm()" style="margin-top:1rem;">Zresetuj</button>
</div>
